generator client {
  provider   = "prisma-client-js"
  engineType = "library"
  output     = "./generated-client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  FINANCE
  COMPLIANCE
  SUPPORT
  OPERATIONAL
  PARTNER
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  BLOCKED
  PENDING
  ANALYSIS
  TERMINATED
}

enum TransactionType {
  PIX_DEPOSIT
  PIX_WITHDRAW
  BOLETO_DEPOSIT
  MERCHANT_PAYMENT
  CASHBACK
  TRANSFER
  FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  LIQUIDATING
}

enum KycStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  role          UserRole  @default(CUSTOMER)
  status        UserStatus @default(PENDING)
  
  // Custom Profile Info
  instagram     String?
  origin        String?    @default("ORGANIC")
  riskScore     Int       @default(0) // 0-100
  
  // Financial Limits (in cents/points)
  dailyLimit    Int       @default(1000000) // R$ 10.000,00
  monthlyLimit  Int       @default(50000000) // R$ 500.000,00
  perTxLimit    Int       @default(500000)   // R$ 5.000,00
  
  // Balance
  pointsBalance Int       @default(0)
  blockedBalance Int      @default(0)
  
  // Auth & Security
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  lastIp          String?
  lastLogin       DateTime?
  
  // KYC Info
  kycStatus     KycStatus @default(NOT_STARTED)
  documentId    String?   @unique // CPF or CNPJ
  phoneNumber   String?
  
  // Relationships
  transactions  Transaction[]
  adminLogs     AdminLog[]    @relation("ResponsibleAdmin")
  actionLogs    AdminLog[]    @relation("TargetUser")
  partner       Partner?      @relation(name: "PartnerOwner")
  carts         Cart[]
  paymentLinks  PaymentLink[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([status])
}

model Partner {
  id          String   @id @default(cuid())
  name        String
  description String?
  logoUrl     String?
  
  ownerId     String   @unique
  owner       User     @relation(name: "PartnerOwner", fields: [ownerId], references: [id])
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  pricePoints Int
  imageUrl    String?
  
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  
  orderItems  OrderItem[]
  cartItems   CartItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  user          User              @relation(fields: [userId], references: [id])
  
  grossAmount   Int               // Raw value
  spread        Int               @default(0) // Fee applied
  netAmount     Int               // Final value after spread
  amount        Int               // Field for backward compatibility or primary display
  
  currency      String            @default("BRL") // BRL or POINTS
  method        String?           // PIX, BOLETO, LINK, INTERNAL
  
  type          TransactionType
  status        TransactionStatus @default(PENDING)
  
  description   String?
  externalId    String?           // PIX E2E, TxHash, etc.
  txid          String?           @unique // For Bolix/Pix
  
  liquidationDate DateTime?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
}

model PaymentLink {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  title       String
  description String?
  amount      Int
  quantity    Int      @default(0) // 0 means unlimited
  totalSales  Int      @default(0)
  
  active      Boolean  @default(true)
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AdminLog {
  id                String   @id @default(cuid())
  responsibleId     String
  responsible       User     @relation("ResponsibleAdmin", fields: [responsibleId], references: [id])
  
  targetUserId      String?
  targetUser        User?    @relation("TargetUser", fields: [targetUserId], references: [id])
  
  action            String   // LOGIN, UPDATE_RATE, BLOCK_USER, APPROVE_KYC, etc.
  details           String?  // JSON stringified details
  ip                String?
  
  createdAt         DateTime @default(now())
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String   @default("GENERAL") // FINANCIAL, SECURITY, etc.
  updatedAt DateTime @updatedAt
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
}

model Order {
  id          String      @id @default(cuid())
  userId      String
  totalPoints Int
  status      String      @default("PAID")
  items       OrderItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  pricePaid Int
}
